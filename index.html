<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Salon V54.0 Elite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #2c3e50; --gold: #D4AF37; --morandi: #A3B8B8; 
            --bg: #F2F2F7; --glass: blur(25px) saturate(180%);
            --breath-speed: 3s;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* é‡‘é‚Šå‘¼å¸å‹•ç•« */
        @keyframes goldBreath {
            0% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); border-color: rgba(212, 175, 55, 0.5); }
            50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); border-color: rgba(212, 175, 55, 1); }
            100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); border-color: rgba(212, 175, 55, 0.5); }
        }

        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: var(--glass); z-index: 2000; border-bottom: 1px solid rgba(212,175,55,0.3); }
        .app-title { font-size: 1.5rem; font-weight: 900; background: linear-gradient(90deg, #2c3e50, var(--gold), #2c3e50); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* æ»‘å‹•å®¹å™¨ */
        .page-slider { display: flex; width: 300%; height: 100%; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .page { width: 33.333%; height: 100%; overflow-y: auto; padding: 20px 15px 180px 15px; }

        /* åœ“èŒå¡ç‰‡ */
        .cust-card { background: #fff; border-radius: 35px; padding: 20px; margin-bottom: 15px; border: 2px solid transparent; transition: 0.3s; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .cust-card:active { transform: scale(0.98); }
        .cust-tag { display: inline-block; background: #f0f0f0; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; margin-right: 5px; color: #666; font-weight: 700; }
        
        /* é ç´„æœå°‹åŠŸèƒ½ */
        .search-bar { background: #fff; border-radius: 25px; display: flex; align-items: center; padding: 10px 20px; margin-bottom: 15px; border: 1px solid #eee; }
        .search-bar input { border: none; flex: 1; outline: none; font-weight: 700; margin-left: 10px; }

        /* æ—¥æ›†èˆ‡æ’ä¼‘ */
        #calendar-container { background: #fff; border-radius: 40px; padding: 15px; box-shadow: 0 15px 45px rgba(0,0,0,0.05); }
        .fc-day-disabled { background: repeating-linear-gradient(45deg, #f9f9f9, #f9f9f9 10px, #f0f0f0 10px, #f0f0f0 20px) !important; opacity: 0.6; }

        /* æ¨™ç±¤æ´»æ€§é¸æ“‡å™¨ */
        .tag-pill { padding: 8px 18px; border-radius: 20px; border: 1px solid #ddd; background: #fff; font-size: 0.85rem; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .tag-pill:hover { border-color: var(--gold); background: #fff9e6; }

        /* åº•éƒ¨å°è¦½åˆ— (é‡‘é‚Šå‘¼å¸) */
        .nav-container { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; z-index: 3000; }
        .nav-bar { display: flex; background: rgba(255, 255, 255, 0.85); backdrop-filter: var(--glass); border-radius: 45px; height: 80px; align-items: center; border: 1.5px solid var(--gold); animation: goldBreath var(--breath-speed) infinite; position: relative; }
        .nav-item { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #999; font-weight: 900; transition: 0.3s; }
        .nav-item.active { color: var(--gold); transform: translateY(-5px); }
        .nav-item i { font-size: 1.4rem; }

        .fab { position: fixed; bottom: 120px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: #fff; border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; z-index: 2500; box-shadow: 0 10px 30px rgba(212,175,55,0.3); }

        /* ä¿®æ”¹å½ˆçª—æ¨£å¼ */
        .swal-round { border-radius: 40px !important; }
    </style>
</head>
<body>

<div class="header">
    <div class="app-title">Salon Elite</div>
    <div style="display:flex; gap:10px;">
        <button onclick="openArchiveSearch()" style="background:none; border:none; font-size:1.2rem; color:var(--gold);"><i class="fas fa-search"></i></button>
        <select id="stylist-filter" onchange="refreshAll()" style="border-radius:15px; border:1px solid var(--gold); padding:5px; font-weight:900;"></select>
    </div>
</div>

<div class="page-slider" id="mainSlider">
    <div class="page">
        <div id="calendar-container"><div id='calendar'></div></div>
    </div>
    
    <div class="page">
        <div class="search-bar">
            <i class="fas fa-search" style="color:var(--gold);"></i>
            <input type="text" id="custSearch" placeholder="æœå°‹å§“åã€é›»è©±æˆ–æ¨™ç±¤..." oninput="renderCustomers()">
        </div>
        <div id="customer-list-render"></div>
    </div>
    
    <div class="page">
        <div class="cust-card">
            <h3>ğŸ¨ è‡ªè¨‚é¡è‰²èˆ‡è¨­è¨ˆå¸«</h3>
            <div id="stylist-manage-render"></div>
            <button onclick="addStylist()" style="width:100%; border-radius:20px; padding:10px; margin-top:10px; border:1px dashed var(--gold); background:none; font-weight:900;">+ æ–°å¢è¨­è¨ˆå¸«</button>
        </div>
        <div class="cust-card">
            <h3>ğŸ“… æ’ä¼‘èˆ‡å…¬ä¼‘æ—¥</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="date" id="offDate" style="flex:1; padding:10px; border-radius:15px; border:1px solid #ddd;">
                <button onclick="addOffDay()" style="background:var(--gold); color:white; border:none; border-radius:15px; padding:0 15px;">æ–°å¢</button>
            </div>
            <div id="off-list-render"></div>
        </div>
        <div class="cust-card">
            <h3>ğŸ·ï¸ æ´»æ€§å¿«é€Ÿæ¨™ç±¤</h3>
            <div id="tag-manage-render" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            <button onclick="addTag()" style="width:100%; margin-top:10px; border-radius:20px; border:1px dashed #ccc; background:none; padding:8px;">+ ç®¡ç†æ¨™ç±¤</button>
        </div>
    </div>
</div>

<button class="fab" onclick="openBookingModal()"><i class="fas fa-plus" style="color:var(--gold); font-size:1.5rem;"></i></button>

<div class="nav-container">
    <div class="nav-bar">
        <button class="nav-item active" onclick="slideTo(0)"><i class="fas fa-calendar-alt"></i><span>é ç´„</span></button>
        <button class="nav-item" onclick="slideTo(1)"><i class="fas fa-heart"></i><span>å–œæ„›å®¢è³‡</span></button>
        <button class="nav-item" onclick="slideTo(2)"><i class="fas fa-sliders-h"></i><span>è¨­å®š</span></button>
    </div>
</div>

<script>
    const KEY = 'SALON_ELITE_V54';
    let data = JSON.parse(localStorage.getItem(KEY)) || {
        bookings: [], customers: [], stylists: [{name:'Tony', color:'#2c3e50'}], tags: ['æŸ“é«®','ç‡™é«®','è­·é«®','å‰ªé«®'], offDays: [], startTime:'09:00', endTime:'21:00'
    };
    let calendar;

    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

    document.addEventListener('DOMContentLoaded', () => {
        initCalendar();
        refreshAll();
    });

    function initCalendar() {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'timeGridDay', headerToolbar: false, locale: 'zh-tw', allDaySlot: false,
            slotMinTime: data.startTime+':00', slotMaxTime: data.endTime+':00',
            events: (info, success) => {
                let evs = data.bookings.map(b => ({
                    id: b.id, title: `${b.stylist}: ${b.customer}\n${b.note}`, start: b.start, backgroundColor: b.color, borderColor:'transparent'
                }));
                data.offDays.forEach(d => evs.push({ start: d, display: 'background', backgroundColor: '#ffdada' }));
                success(evs);
            },
            eventClick: (info) => openBookingModal(null, null, info.event.id)
        });
        calendar.render();
    }

    // å·¦å³æ»‘å‹•
    function slideTo(idx) {
        document.getElementById('mainSlider').style.transform = `translateX(-${idx * 33.333}%)`;
        document.querySelectorAll('.nav-item').forEach((btn, i) => btn.classList.toggle('active', i === idx));
        if(idx === 1) renderCustomers();
        if(idx === 2) renderSettings();
    }

    // æ´»æ€§é ç´„å½ˆçª—
    async function openBookingModal(date, time, editId = null) {
        let b = editId ? data.bookings.find(x => x.id == editId) : null;
        const { value: res, isDenied } = await Swal.fire({
            title: b ? 'ä¿®æ”¹é ç´„' : 'å¿«é€Ÿé ç´„', customClass: { popup: 'swal-round' },
            showDenyButton: !!editId, denyButtonText: 'åˆªé™¤é ç´„',
            html: `
                <div style="text-align:left;">
                    <input id="sw-n" class="swal2-input" placeholder="å®¢æˆ¶å§“å" value="${b?b.customer:''}">
                    <input id="sw-p" class="swal2-input" placeholder="é›»è©±" value="${b?b.phone:''}">
                    <div style="margin:15px 0 5px 0; font-weight:900;">é …ç›®æ¨™ç±¤ (é»æ“Šå¡«å…¥)ï¼š</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                        ${data.tags.map(t => `<div class="tag-pill" onclick="document.getElementById('sw-o').value += '${t} '">${t}</div>`).join('')}
                    </div>
                    <textarea id="sw-o" class="swal2-textarea" placeholder="è©³ç´°å…§å®¹...">${b?b.note:''}</textarea>
                    <select id="sw-s" class="swal2-input">${data.stylists.map(s=>`<option value="${s.name}|${s.color}" ${b&&b.stylist==s.name?'selected':''}>${s.name}</option>`).join('')}</select>
                    <div style="display:flex; gap:5px;">
                        <input id="sw-d" type="date" class="swal2-input" value="${b?b.start.split('T')[0]:new Date().toLocaleDateString('sv')}">
                        <input id="sw-t" type="time" class="swal2-input" value="${b?b.start.split('T')[1].substring(0,5):'10:00'}">
                    </div>
                </div>
            `,
            preConfirm: () => ({ name: document.getElementById('sw-n').value, phone: document.getElementById('sw-p').value, note: document.getElementById('sw-o').value, stylist: document.getElementById('sw-s').value, date: document.getElementById('sw-d').value, time: document.getElementById('sw-t').value })
        });

        if(isDenied) { data.bookings = data.bookings.filter(x => x.id != editId); save(); refreshAll(); }
        else if(res && res.name) {
            const [sName, sColor] = res.stylist.split('|');
            const bData = { id: editId||Date.now(), customer: res.name, phone: res.phone, note: res.note, stylist: sName, color: sColor, start: `${res.date}T${res.time}` };
            if(editId) data.bookings[data.bookings.findIndex(x=>x.id==editId)] = bData; else data.bookings.push(bData);
            
            // è‡ªå‹•åŒæ­¥åˆ°å®¢è³‡
            if(!data.customers.find(c => c.name === res.name)) data.customers.push({name: res.name, phone: res.phone, tags: [], bday: '', color: sColor});
            save(); refreshAll();
        }
    }

    // åœ“èŒå®¢è³‡å¡
    function renderCustomers() {
        const q = document.getElementById('custSearch').value.toLowerCase();
        const area = document.getElementById('customer-list-render');
        area.innerHTML = '';
        data.customers.filter(c => c.name.includes(q) || c.phone.includes(q) || c.tags.some(t=>t.includes(q))).forEach((c, idx) => {
            const history = data.bookings.filter(b => b.customer === c.name).sort((a,b)=>new Date(b.start)-new Date(a.start)).slice(0,3);
            area.innerHTML += `
                <div class="cust-card" style="border-left: 10px solid ${c.color || '#ddd'}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <strong style="font-size:1.2rem;">${c.name}</strong> 
                            <span style="font-size:0.8rem; color:#aaa;">ğŸ‚ ${c.bday||'æœªè¨­å®š'}</span><br>
                            <span style="color:var(--gold); font-weight:700;">ğŸ“ ${c.phone}</span>
                        </div>
                        <button onclick="editCust(${idx})" style="background:none; border:none; color:var(--morandi);"><i class="fas fa-edit"></i></button>
                    </div>
                    <div style="margin:10px 0;">
                        ${c.tags.map(t => `<span class="cust-tag">#${t}</span>`).join('')}
                    </div>
                    <div style="background:#fcfcfc; border-radius:15px; padding:10px; font-size:0.75rem;">
                        <strong>æœ€å¾Œé ç´„ï¼š</strong><br>
                        ${history.map(h => `<div>â€¢ ${h.start.split('T')[0]} (${h.note})</div>`).join('') || 'ç„¡ç´€éŒ„'}
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <a href="tel:${c.phone}" style="flex:1; background:#e1f5fe; color:#03a9f4; text-align:center; padding:10px; border-radius:15px; text-decoration:none; font-weight:900;">æ’¥æ‰“</a>
                        <button onclick="openBookingModal(null,null,null); document.getElementById('sw-n').value='${c.name}'; document.getElementById('sw-p').value='${c.phone}';" style="flex:1; background:var(--gold); color:white; border:none; padding:10px; border-radius:15px; font-weight:900;">é ç´„</button>
                    </div>
                </div>
            `;
        });
    }

    async function editCust(idx) {
        let c = data.customers[idx];
        const { value: res } = await Swal.fire({
            title: 'ä¿®æ”¹å®¢è³‡', html: `
                <input id="ec-n" class="swal2-input" placeholder="å§“å" value="${c.name}">
                <input id="ec-p" class="swal2-input" placeholder="é›»è©±" value="${c.phone}">
                <input id="ec-b" type="date" class="swal2-input" value="${c.bday}">
                <input id="ec-t" class="swal2-input" placeholder="æ¨™ç±¤(ç©ºç™½éš”é–‹)" value="${c.tags.join(' ')}">
                <input id="ec-c" type="color" class="swal2-input" value="${c.color || '#A3B8B8'}">
            `,
            preConfirm: () => ({ name: document.getElementById('ec-n').value, phone: document.getElementById('ec-p').value, bday: document.getElementById('ec-b').value, tags: document.getElementById('ec-t').value.split(' ').filter(x=>x), color: document.getElementById('ec-c').value })
        });
        if(res) { data.customers[idx] = res; save(); renderCustomers(); }
    }

    // æ­¸æª”æœç´¢
    async function openArchiveSearch() {
        const { value: q } = await Swal.fire({ title: 'é ç´„ç¸½æª”æ¡ˆæœå°‹', input: 'text', inputPlaceholder: 'æœå°‹å§“åæˆ–é …ç›®å…§å®¹...' });
        if(q) {
            const found = data.bookings.filter(b => b.customer.includes(q) || b.note.includes(q));
            Swal.fire({
                title: `æ‰¾åˆ° ${found.length} ç­†è³‡æ–™`,
                html: found.map(f => `<div style="text-align:left; border-bottom:1px solid #eee; padding:10px;"><b>${f.start.split('T')[0]}</b> - ${f.customer}<br>${f.note}</div>`).join('')
            });
        }
    }

    function refreshAll() {
        updateStylistFilter();
        if(calendar) calendar.refetchEvents();
        save();
    }

    function renderSettings() {
        document.getElementById('stylist-manage-render').innerHTML = data.stylists.map((s,i) => `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><i class="fas fa-circle" style="color:${s.color}"></i> ${s.name}</span>
                <i class="fas fa-trash" style="color:#ff7675;" onclick="data.stylists.splice(${i},1); refreshAll(); renderSettings();"></i>
            </div>
        `).join('');
        document.getElementById('off-list-render').innerHTML = data.offDays.map((d,i)=>`<div style="display:flex; justify-content:space-between;"><span>${d}</span><i class="fas fa-times" onclick="data.offDays.splice(${i},1); refreshAll(); renderSettings();"></i></div>`).join('');
        document.getElementById('tag-manage-render').innerHTML = data.tags.map(t => `<span class="cust-tag">#${t}</span>`).join('');
    }

    async function addStylist() {
        const { value: res } = await Swal.fire({
            title: 'æ–°å¢è¨­è¨ˆå¸«',
            html: `<input id="as-n" class="swal2-input" placeholder="å§“å"><input id="as-c" type="color" class="swal2-input" value="#D4AF37">`,
            preConfirm: () => ({ name: document.getElementById('as-n').value, color: document.getElementById('as-c').value })
        });
        if(res && res.name) { data.stylists.push(res); refreshAll(); renderSettings(); }
    }

    function addOffDay() {
        const d = document.getElementById('offDate').value;
        if(d && !data.offDays.includes(d)) { data.offDays.push(d); refreshAll(); renderSettings(); }
    }

    async function addTag() {
        const { value: t } = await Swal.fire({ title: 'æ¨™ç±¤ç®¡ç†', input: 'textarea', inputValue: data.tags.join(' '), inputPlaceholder: 'ä½¿ç”¨ç©ºæ ¼å€åˆ†æ¨™ç±¤' });
        if(t !== undefined) { data.tags = t.split(' ').filter(x=>x); save(); renderSettings(); }
    }

    function updateStylistFilter() {
        const s = document.getElementById('stylist-filter');
        s.innerHTML = '<option value="all">æ‰€æœ‰è¨­è¨ˆå¸«</option>' + data.stylists.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
    }
</script>
</body>
</html>
